<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Dashboard</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans text-gray-900">

  <!-- Sidebar -->
  <nav class="fixed top-0 left-0 h-full w-56 bg-orange-600 flex flex-col justify-between py-6 shadow-xl">
    <div>
      <div class="flex justify-center mb-6">
        <img src="../../images/BarDeli Logo (White).png" class="h-24 w-auto" alt="Logo">
      </div>
      <div class="flex flex-col space-y-2">
        <a href="customerhomepage.html"
          class="flex items-center gap-3 px-4 py-3 text-white font-bold rounded bg-orange-800">
          <i class="fa-regular fa-house"></i> Home
        </a>
        <a href="customerbookingpage.html"
          class="flex items-center gap-3 px-4 py-3 text-white font-bold rounded hover:bg-orange-500 transition">
          <i class="fa-regular fa-calendar"></i> Booking
        </a>
        <a href="customernotificationspage.html"
          class="flex items-center gap-3 px-4 py-3 text-white font-bold rounded hover:bg-orange-500 transition">
          <i class="fa-regular fa-bell"></i> Notifications
        </a>
        <a href="customerprofilepage.html"
          class="flex items-center gap-3 px-4 py-3 text-white font-bold rounded hover:bg-orange-500 transition">
          <i class="fa-regular fa-user"></i> Profile
        </a>
      </div>
    </div>
    <div class="flex justify-center">
      <a href="../../index.html"
        class="flex items-center gap-3 px-4 py-3 text-white font-bold rounded hover:bg-orange-500 transition">
        <i class="fa-solid fa-arrow-right-from-bracket"></i> Logout
      </a>
    </div>
  </nav>

  <!-- Dashboard -->
  <main class="ml-56 p-10">
    <h1 class="text-4xl font-extrabold text-gray-800">
      Welcome, <span id="customerName" class="text-orange-600">Loading...</span>
    </h1>
    <p class="text-gray-600 mt-2">Hereâ€™s an overview of your catering bookings</p>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
      <div class="bg-gradient-to-r from-orange-500 to-orange-600 p-6 rounded-xl shadow-lg hover:shadow-xl transition">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold text-white">Total Bookings</h2>
          <i class="fa-regular fa-calendar text-white text-3xl"></i>
        </div>
        <p id="totalBookings" class="text-5xl text-white font-extrabold mt-4">0</p>
        <p class="text-white text-sm mt-5">Events successfully booked</p>
      </div>

      <div class="bg-gradient-to-r from-orange-500 to-orange-600 p-6 rounded-xl shadow-lg hover:shadow-xl transition">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold text-white">Last Booking</h2>
          <i class="fa-regular fa-clock text-white text-3xl"></i>
        </div>
        <div class="mt-4 space-y-2 text-white">
          <p id="lastDate" class="font-semibold">Date: none</p>
          <p id="lastGuests" class="font-semibold">Number of Guests: none</p>
          <p id="lastLocation" class="font-semibold">Location: none</p>
        </div>
      </div>
    </div>

    <!-- Recent Bookings -->
    <div class="bg-white rounded-xl mt-10 p-6 shadow-lg">
      <h2 class="text-2xl text-gray-800 font-bold mb-4 border-b pb-3">Recent Bookings</h2>
      <div id="Recent-bookings" class="overflow-y-auto max-h-[450px] space-y-4 pr-2"></div>
    </div>
  </main>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabaseUrl = "https://fawlfsukrqrucrrxrjvq.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhd2xmc3VrcnFydWNycnhyanZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzU2OTUsImV4cCI6MjA3MTAxMTY5NX0.KGH5SAJvCEhnz3NHdp6LeMgCvZp-nP1Tj6oIL32J6K8";
    const supabase = createClient(supabaseUrl, supabaseKey);
    
    //Checks if user is signed in
    const { data: { user }, error: userError } = await supabase.auth.getUser();
    if (userError || !user) window.location.href = "login.html";
    
    //Retrieves signedin user's first and last names
    async function loadUserProfile() {
      try {
        const { data, error } = await supabase
          .from("users")
          .select("user_id, first_name, last_name")
          .eq("auth_user_id", user.id)
          .single();

        if (error) throw error;

        const fullName = `${data.first_name} ${data.last_name}`.trim() || "Customer";
        document.getElementById("customerName").textContent = fullName;

        localStorage.setItem("user", JSON.stringify({
          id: data.user_id,         // add id for other pages that expect .id
          user_id: data.user_id,    // keep original name too (optional)
          first_name: data.first_name,
          last_name: data.last_name,
          fullName
        }));
      } catch (err) {
        console.error("Error loading user profile:", err);
        document.getElementById("customerName").textContent = "Customer";
      }
    }
    
    //Loads booking information (still to be tested when booking table has bookings)
    async function loadBookings() {
      const userData = JSON.parse(localStorage.getItem("user"));
      if (!userData?.user_id) return;

      const { data: bookings, error } = await supabase
        .from("booking")
        .select("*")
        .eq("user_id", userData.user_id)
        .order("event_date", { ascending: false });

      if (error) {
        console.error("Error fetching bookings:", error);
        return;
      }

      document.getElementById("totalBookings").textContent = bookings?.length || 0;

      const lastBooking = bookings?.[0];
      document.getElementById("lastDate").textContent = `Date: ${lastBooking?.event_date || "none"}`;
      document.getElementById("lastGuests").textContent = `Guests: ${lastBooking?.guest_count || "none"}`;
      document.getElementById("lastLocation").textContent = `Location: ${lastBooking?.location || "none"}`;

      const recentDiv = document.getElementById("Recent-bookings");
      recentDiv.innerHTML = "";
      bookings.forEach(b => {
        const statusColor = {
          Pending: "bg-yellow-700",
          In_Progress: "bg-orange-700",
          Completed: "bg-green-700",
          Cancelled: "bg-red-700"
        }[b.status] || "bg-gray-500";

        recentDiv.insertAdjacentHTML("beforeend", `
          <div class="bg-gradient-to-r from-orange-400 to-orange-500 rounded-xl p-5 shadow-md hover:shadow-xl transition relative">
            <div class="absolute top-3 right-3 flex gap-2">
              <span class="bg-orange-700 text-white font-bold px-3 py-1 rounded-lg text-xs">${b.event_type || "Event"}</span>
              <span class="${statusColor} text-white font-bold px-3 py-1 rounded-lg text-xs">${b.status || "Unknown"}</span>
            </div>
            <p class="font-bold text-lg text-white mb-2"><i class="fa-regular fa-calendar mr-1"></i> ${b.event_date || "TBD"}</p>
            <div class="grid grid-cols-2 gap-x-6 text-sm text-white">
              <p><i class="fa-solid fa-users mr-1.5"></i> Number of Guests: ${b.guest_count || 0}</p>
              <p><i class="fa-solid fa-location-dot mr-1.5"></i> Event Location: ${b.location || "TBD"}</p>
              <p><i class="fa-regular fa-clock mr-1.5"></i> Event Time: ${b.event_time || "TBD"}</p>
            </div>
          </div>
        `);
      });
    }

    await loadUserProfile();
    await loadBookings();
   </script>
</body>
</html>
