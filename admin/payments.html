<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Manage Payments - BarDeli</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						"bardeli-orange": "#ff6b35",
						"bardeli-dark": "#e55a2b",
						"bardeli-light": "#ff8f66",
					},
				},
			},
		};
	</script>
</head>

<body class="bg-gray-50 min-h-screen">
	<!-- Header -->
	<header class="bg-white shadow-sm border-b border-gray-200">
		<div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="flex justify-between items-center py-4">
				<a href="admin-dashboard.html"
					class="flex items-center text-bardeli-orange hover:text-bardeli-dark transition-colors">
					<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
					</svg>
					Back to Dashboard
				</a>
				<h1 class="text-2xl font-bold text-gray-900">Payments</h1>
				<div class="w-32"></div>
			</div>
		</div>
	</header>

	<!-- Main Content -->
	<main class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<div class="flex justify-between items-center mb-8">
			<div>
				<h2 class="text-3xl font-bold text-gray-900">Manage Payments</h2>
				<p class="text-gray-600 mt-2">View and manage all catering booking payments</p>
			</div>
		</div>

		<!-- Filters -->
		<div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
			<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
				<input type="text" id="searchInput" placeholder="Search customers..."
					class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-bardeli-orange focus:border-transparent" />
				<select id="statusFilter"
					class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-bardeli-orange focus:border-transparent">
					<option value="">All Status</option>
					<option value="Pending">Pending</option>
					<option value="In Progress">In Progress</option>
					<option value="Completed">Completed</option>
					<option value="Cancelled">Cancelled</option>
				</select>
				<button onclick="loadPayments()"
					class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
					Refresh
				</button>
			</div>
		</div>

		<!-- Payments Table -->
		<div class="bg-white rounded-lg shadow-sm border border-gray-200">
			<div class="px-6 py-4 border-b border-gray-200">
				<h3 class="text-lg font-semibold text-gray-900">Bookings and Payment Proofs</h3>
			</div>
			<div class="overflow-x-auto">
				<table class="min-w-full divide-y divide-gray-200">
					<thead class="bg-gray-50">
						<tr>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Booking ID</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Cost</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Deposit to be
								Paid</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment Proofs
							</th>
						</tr>
					</thead>
					<tbody id="eventsBody" class="bg-white divide-y divide-gray-200"></tbody>
				</table>
			</div>
		</div>
	</main>

	<script type="module">
		import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

		const supabaseUrl = "https://fawlfsukrqrucrrxrjvq.supabase.co";
		const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhd2xmc3VrcnFydWNycnhyanZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzU2OTUsImV4cCI6MjA3MTAxMTY5NX0.KGH5SAJvCEhnz3NHdp6LeMgCvZp-nP1Tj6oIL32J6K8";
		const supabase = createClient(supabaseUrl, supabaseKey);
		const bucketName = "payment-proofs";

		const tableBody = document.getElementById("eventsBody");
		const searchInput = document.getElementById("searchInput");
		const statusFilter = document.getElementById("statusFilter");

		let allPayments = [];
		let proofFiles = [];

		document.addEventListener("DOMContentLoaded", async () => {
			await loadPayments();

			// Add event listeners for filters
			searchInput.addEventListener("input", applyFilters);
			statusFilter.addEventListener("change", applyFilters);
		});

		// Recursive list of all files in bucket
		async function listAllFiles(path = "") {
			const { data, error } = await supabase.storage.from(bucketName).list(path, { limit: 100 });
			if (error || !data) return [];
			let allFiles = [];
			for (const item of data) {
				if (item.metadata === null) {
					const subFiles = await listAllFiles(`${path ? path + "/" : ""}${item.name}`);
					allFiles = allFiles.concat(subFiles);
				} else {
					allFiles.push({
						name: item.name,
						fullPath: `${path ? path + "/" : ""}${item.name}`,
					});
				}
			}
			return allFiles;
		}

		async function loadPayments() {
			tableBody.innerHTML = "<tr><td colspan='6' class='text-center py-4'>Loading...</td></tr>";

			const { data: payments, error } = await supabase
				.from("payment")
				.select(`
	                payment_id,
	                status,
	                booking:booking_id (booking_id, total_cost, deposit_paid,
	                user:users (first_name, last_name)
	                )
	            `)
				.order("booking_id", { ascending: true });

			if (error) {
				console.error(error);
				tableBody.innerHTML = "<tr><td colspan='6' class='text-center py-4 text-red-500'>Error loading data.</td></tr>";
				return;
			}

			proofFiles = await listAllFiles();
			allPayments = payments; // store for filtering
			renderPayments(allPayments);
		}

		// Filter + re-render
		function applyFilters() {
			const searchTerm = searchInput.value.toLowerCase();
			const statusValue = statusFilter.value;

			const filtered = allPayments.filter(p => {
				const user = p.booking.user;
				const fullName = `${user.first_name} ${user.last_name}`.toLowerCase();
				const matchesSearch = fullName.includes(searchTerm) || p.booking.booking_id.toString().includes(searchTerm);
				const matchesStatus = !statusValue || p.status === statusValue;
				return matchesSearch && matchesStatus;
			});

			renderPayments(filtered);
		}

		// Render payment rows
		function renderPayments(payments) {
			tableBody.innerHTML = "";

			if (!payments.length) {
				tableBody.innerHTML = "<tr><td colspan='6' class='text-center py-4 text-gray-500'>No results found.</td></tr>";
				return;
			}

			for (const p of payments) {
				const booking = p.booking;
				const user = booking.user;
				const bookingId = booking.booking_id;

				// Find files belonging to this booking
				const linkedProofs = proofFiles.filter(f =>
					f.fullPath.startsWith(`${bookingId}/`)
				);

				const proofHTML = linkedProofs.length
					? linkedProofs.map(f => {
						const { data: urlData } = supabase.storage.from(bucketName).getPublicUrl(f.fullPath);
						const url = urlData.publicUrl;
						if (f.name.match(/\.(jpg|jpeg|png|gif)$/i)) {
							return `
	              <a href="${url}" target="_blank" class="inline-block mr-2 mb-2">
	                <img src="${url}" alt="${f.name}" class="w-12 h-12 object-cover rounded border border-gray-300 hover:opacity-80 transition" />
	              </a>`;
						} else {
							return `
	              <a href="${url}" target="_blank" class="inline-flex items-center px-2 py-1 bg-gray-100 border border-gray-300 rounded text-sm text-red-600 hover:bg-gray-200 transition mr-2 mb-2">
	                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor">
	                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
	                </svg>
	                PDF
	              </a>`;
						}
					}).join("")
					: `<span class="text-gray-400">No proofs</span>`;

				const row = document.createElement("tr");
				row.innerHTML = `
	                  <td class="px-6 py-4">${bookingId}</td>
	                  <td class="px-6 py-4">${user.first_name} ${user.last_name}</td>
	                  <td class="px-6 py-4">R${booking.total_cost}</td>
	                  <td class="px-6 py-4">R${booking.deposit_paid}</td>
	                  <td class="px-6 py-4">
	                        <select onchange="updateStatus(${p.payment_id}, ${bookingId}, this.value)"
	                        class="border border-gray-300 rounded-md px-2 py-1 focus:ring-2 focus:ring-bardeli-orange">
	                        ${["Pending", "In Progress", "Completed", "Cancelled"]
						    .map(status => `<option value="${status}" ${p.status === status ? "selected" : ""}>${status}</option>`)
						    .join("")}
	                        </select>
	                  </td>
	                  <td class="px-6 py-4 flex flex-wrap">${proofHTML}</td>
	            `;

				tableBody.appendChild(row);
			}
		}

		// Update status in both tables
		window.updateStatus = async function (paymentId, bookingId, newStatus) {
			const confirmChange = confirm(`Change status to "${newStatus}"?`);
			if (!confirmChange) return;

			const { error: pErr } = await supabase.from("payment").update({ status: newStatus }).eq("payment_id", paymentId);
			const { error: bErr } = await supabase.from("booking").update({ status: newStatus }).eq("booking_id", bookingId);

			if (pErr || bErr) return alert("Error updating status");
			alert("Status updated successfully!");
			loadPayments();
		};
		
	</script>

</body>

</html>