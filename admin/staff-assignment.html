<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <title>Staff Assignment - BarDeli Admin</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <script src="https://cdn.tailwindcss.com"></script>
   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
   <script>
       tailwind.config = {
           theme: {
               extend: {
                   colors: {
                       'bardeli-orange': '#ff6b35',
                       'bardeli-dark': '#e55a2b',
                       'bardeli-light': '#ff8f66'
                   }
               }
           }
       }
   </script>
   <style>
       .header-bg {
           background: linear-gradient(135deg, #ff6b35 0%, #e55a2b 100%);
       }
   </style>
</head>
<body class="bg-gray-50 min-h-screen">
   <!-- Header -->
   <div class="header-bg shadow-lg">
       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
           <div class="flex items-center justify-between h-16">
               <div class="flex items-center space-x-4">
                   <a href="admin-dashboard.html" class="text-white hover:text-bardeli-light">
                       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                       </svg>
                   </a>
                   <h1 class="text-2xl font-bold text-white">Staff Assignment</h1>
               </div>
               <div class="flex items-center space-x-4">
                   <button id="createAssignmentBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium">
                       + Assign Staff
                   </button>
                   <button id="logoutBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg text-sm">
                       Logout
                   </button>
               </div>
           </div>
       </div>
   </div>

   <!-- Main Content -->
   <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
       <!-- Stats -->
       <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
           <div class="bg-white rounded-xl shadow-md p-6">
               <h3 class="text-lg font-semibold text-gray-900 mb-2">Total Assignments</h3>
               <p id="totalAssignments" class="text-3xl font-bold text-bardeli-orange">0</p>
           </div>
           <div class="bg-white rounded-xl shadow-md p-6">
               <h3 class="text-lg font-semibold text-gray-900 mb-2">Active Staff</h3>
               <p id="activeStaff" class="text-3xl font-bold text-blue-600">0</p>
           </div>
           <div class="bg-white rounded-xl shadow-md p-6">
               <h3 class="text-lg font-semibold text-gray-900 mb-2">Upcoming Events</h3>
               <p id="upcomingEvents" class="text-3xl font-bold text-green-600">0</p>
           </div>
       </div>

       <!-- Assignments List -->
       <div class="bg-white rounded-xl shadow-md border border-gray-200">
           <div class="px-6 py-4 border-b border-gray-200">
               <h3 class="text-lg font-semibold text-gray-900">Staff Assignments</h3>
           </div>
           <div id="assignmentsContainer">
               <!-- Empty state -->
               <div id="emptyState" class="p-12 text-center">
                   <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                       <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                       </svg>
                   </div>
                   <h3 class="text-lg font-medium text-gray-900 mb-2">No staff assignments yet</h3>
                   <p class="text-gray-500 mb-6">Start by assigning staff to events.</p>
                   <button id="createFirstBtn" class="bg-bardeli-orange hover:bg-bardeli-dark text-white px-6 py-3 rounded-lg font-medium">
                       Create First Assignment
                   </button>
               </div>
           </div>
       </div>
   </div>

   <!-- Multi-Staff Assignment Modal -->
   <div id="assignmentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-50">
       <div class="flex items-center justify-center min-h-screen p-4">
           <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
               <div class="flex items-center justify-between p-6 border-b border-gray-200">
                   <h3 class="text-lg font-bold text-gray-900">Assign Staff to Event</h3>
                   <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                       </svg>
                   </button>
               </div>
               
               <div class="flex-1 overflow-y-auto p-6">
                   <form id="assignmentForm" class="space-y-6">
                       <div>
                           <label class="block text-sm font-medium text-gray-700 mb-2">Select Event</label>
                           <select id="eventSelect" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-bardeli-orange focus:border-bardeli-orange">
                               <option value="">Choose an event...</option>
                           </select>
                       </div>
                       
                       <div>
                           <label class="block text-sm font-medium text-gray-700 mb-2">Staff & Role Assignments</label>
                           <div id="staffAssignments" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                               <!-- Staff assignment rows will be added here -->
                           </div>
                           <button type="button" id="addStaffBtn" class="mt-3 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm flex items-center space-x-2">
                               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                               </svg>
                               <span>Add Staff Member</span>
                           </button>
                       </div>
                   </form>
               </div>
               
               <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                   <button type="button" id="cancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700">
                       Cancel
                   </button>
                   <button type="submit" form="assignmentForm" class="bg-bardeli-orange hover:bg-bardeli-dark text-white px-6 py-2 rounded-lg font-medium">
                       Assign All Staff
                   </button>
               </div>
           </div>
       </div>
   </div>

   <!-- Staff Details Modal -->
   <div id="staffDetailsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-50">
       <div class="flex items-center justify-center min-h-screen p-4">
           <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
               <div class="flex items-center justify-between mb-4">
                   <h3 id="staffDetailsTitle" class="text-lg font-bold text-gray-900">Assigned Staff</h3>
                   <button id="closeStaffModal" class="text-gray-400 hover:text-gray-600">
                       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                       </svg>
                   </button>
               </div>
               
               <div id="staffDetailsList" class="space-y-3 max-h-96 overflow-y-auto">
                   <!-- Staff details will be populated here -->
               </div>
           </div>
       </div>
   </div>

   <script>
       // Initialize with team database
       const { createClient } = supabase;
       const supabaseClient = createClient(
           'https://fawlfsukrqrucrrxrjvq.supabase.co', 
           'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhd2xmc3VrcnFydUNCYXJkZWxpbmUiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE2NzU1MjYwMjIsImV4cCI6MjA3MTAxMTYwMn0.8G5SAJvCEhnz3NHdp6LeMgCvZp-nP1Tj6oIL32J6K8'
       );

       let allBookings = [];
       let allStaff = [];
       let assignments = [];
       let staffRowCount = 0;

       // Load data on page load
       document.addEventListener('DOMContentLoaded', function() {
           loadData();
           setupEventListeners();
       });

       async function loadData() {
           try {
               await Promise.all([loadBookings(), loadStaff(), loadAssignments()]);
               renderGroupedAssignments();
               updateStats();
               populateEventDropdown();
           } catch (error) {
               console.error('Error:', error);
               showError('Failed to load data');
           }
       }

       async function loadBookings() {
           const { data, error } = await supabaseClient
               .from('booking')
               .select('booking_id, event_date, event_type, location, guest_count, status')
               .eq('status', 'In Progress')
               .order('event_date', { ascending: true });

           if (error) throw error;
           allBookings = data || [];
       }

       async function loadStaff() {
           const { data, error } = await supabaseClient
               .from('staff')
               .select('staff_id, first_name, last_name, position, role, is_active')
               .eq('is_active', true)
               .order('last_name', { ascending: true });

           if (error) throw error;
           allStaff = data || [];
       }

       async function loadAssignments() {
           try {
               const { data, error } = await supabaseClient
                   .from('staff_assignment')
                   .select('assignment_id, booking_id, staff_id, role_assignment, status, created_at');

               if (error && error.code !== 'PGRST116') throw error;
               assignments = data || [];
           } catch (error) {
               assignments = [];
           }
       }

       // Group assignments by event
       function groupAssignmentsByEvent(assignments) {
           const grouped = {};
           assignments.forEach(assignment => {
               const bookingId = assignment.booking_id;
               if (!grouped[bookingId]) {
                   const booking = allBookings.find(b => b.booking_id === bookingId);
                   grouped[bookingId] = {
                       booking: booking,
                       assignments: []
                   };
               }
               grouped[bookingId].assignments.push(assignment);
           });
           return grouped;
       }

       // Render grouped assignments
       function renderGroupedAssignments() {
           const container = document.getElementById('assignmentsContainer');
           const emptyState = document.getElementById('emptyState');

           if (!assignments.length) {
               emptyState.style.display = 'block';
               return;
           }

           emptyState.style.display = 'none';
           
           const groupedAssignments = groupAssignmentsByEvent(assignments);
           
           container.innerHTML = Object.entries(groupedAssignments).map(([bookingId, eventData]) => `
               <div class="p-6 border-b border-gray-200 hover:bg-gray-50">
                   <div class="flex items-center justify-between">
                       <div class="flex-1">
                           <h4 class="font-semibold text-gray-900 text-lg">${eventData.booking?.event_type || 'Unknown Event'}</h4>
                           <p class="text-sm text-gray-500 mt-1">${new Date(eventData.booking?.event_date).toLocaleDateString()}</p>
                           <p class="text-xs text-gray-400">${eventData.booking?.location || 'No location'} â€¢ ${eventData.booking?.guest_count || 0} guests</p>
                       </div>
                       <div class="flex items-center space-x-3">
                           <button onclick="showAssignedStaff('${bookingId}')" class="bg-bardeli-orange hover:bg-bardeli-dark text-white px-4 py-2 rounded-lg font-medium text-sm flex items-center space-x-2">
                               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                               </svg>
                               <span>Assigned Staff (${eventData.assignments.length})</span>
                           </button>
                           <button onclick="deleteEventAssignments('${bookingId}')" class="text-red-500 hover:text-red-700 p-2">
                               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                               </svg>
                           </button>
                       </div>
                   </div>
               </div>
           `).join('');
       }

       // FIXED: Make these functions global so onclick handlers can find them
       window.showAssignedStaff = function(bookingId) {
           const groupedAssignments = groupAssignmentsByEvent(assignments);
           const eventData = groupedAssignments[bookingId];
           if (!eventData) return;

           document.getElementById('staffDetailsTitle').textContent = `Assigned Staff - ${eventData.booking?.event_type || 'Event'}`;

           const staffList = eventData.assignments.map(assignment => {
               const staff = allStaff.find(s => s.staff_id === assignment.staff_id) || {};
               const firstName = staff.first_name || '';
               const lastName = staff.last_name || 'Unknown Staff';
               const position = staff.position || 'Unknown Position';
               const role = assignment.role_assignment || 'No role';
               const status = assignment.status || 'Unknown';

               return `
                   <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                       <div>
                           <h5 class="font-medium text-gray-900">${firstName} ${lastName}</h5>
                           <p class="text-sm text-gray-600">${position}</p>
                           <p class="text-sm text-bardeli-orange font-medium">Role: ${role}</p>
                           <p class="text-sm text-gray-500">Status: ${status}</p>
                       </div>
                       <button onclick="deleteAssignment('${assignment.assignment_id}')" class="text-red-500 hover:text-red-700 p-1">
                           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                     d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                           </svg>
                       </button>
                   </div>
               `;
           }).join('');

           document.getElementById('staffDetailsList').innerHTML = staffList;
           document.getElementById('staffDetailsModal').classList.remove('hidden');
       }

       window.deleteAssignment = async function(id) {
           if (!confirm('Delete this assignment?')) return;
           
           try {
               const { error } = await supabaseClient
                   .from('staff_assignment')
                   .delete()
                   .eq('assignment_id', id);

               if (error) throw error;
               await loadData(); // Reload data
               // Close the staff details modal to refresh the view
               document.getElementById('staffDetailsModal').classList.add('hidden');
               showSuccess('Assignment removed!');
           } catch (error) {
               console.error('Error deleting assignment:', error);
               showError('Failed to remove assignment');
           }
       }

       window.deleteEventAssignments = async function(bookingId) {
           const groupedAssignments = groupAssignmentsByEvent(assignments);
           const eventData = groupedAssignments[bookingId];
           
           if (!eventData || !eventData.booking) return;
           const eventType = eventData.booking.event_type || 'this event';
           if (!confirm(`Delete all assignments for ${eventType}?`)) return;
           
           try {
               const { error } = await supabaseClient
                   .from('staff_assignment')
                   .delete()
                   .eq('booking_id', bookingId);

               if (error) throw error;
               await loadData();
               showSuccess('All assignments removed!');
           } catch (error) {
               console.error('Error deleting event assignments:', error);
               showError('Failed to remove assignments');
           }
       }

       function updateStats() {
           document.getElementById('totalAssignments').textContent = assignments.length;
           document.getElementById('activeStaff').textContent = allStaff.length;
           document.getElementById('upcomingEvents').textContent = allBookings.length;
       }

       function populateEventDropdown() {
           const eventSelect = document.getElementById('eventSelect');
           eventSelect.innerHTML = '<option value="">Choose an event...</option>';
           allBookings.forEach(booking => {
               const eventDate = booking.event_date ? new Date(booking.event_date).toLocaleDateString() : 'TBD';
               eventSelect.innerHTML += `
                   <option value="${booking.booking_id}">
                       ${booking.event_type || 'Event'} - ${eventDate} (${booking.guest_count || 0} guests)
                   </option>
               `;
           });
       }

       // Create staff dropdown HTML
       function createStaffDropdown(rowId) {
           let options = '<option value="">Select Staff...</option>';
           allStaff.forEach(staff => {
               options += `<option value="${staff.staff_id}">${staff.first_name} ${staff.last_name} - ${staff.position}</option>`;
           });
           return options;
       }

       // Add staff assignment row
       function addStaffRow() {
           staffRowCount++;
           const staffContainer = document.getElementById('staffAssignments');
           
           const rowDiv = document.createElement('div');
           rowDiv.className = 'flex space-x-3 items-center p-3 bg-gray-50 rounded-lg';
           rowDiv.id = `staffRow${staffRowCount}`;
           
           rowDiv.innerHTML = `
               <select class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-bardeli-orange focus:border-bardeli-orange staff-select" required>
                   ${createStaffDropdown(staffRowCount)}
               </select>
               <select class="w-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-bardeli-orange focus:border-bardeli-orange role-select" required>
                   <option value="Chef">Chef</option>
                   <option value="Server">Server</option>
                   <option value="Bartender">Bartender</option>
                   <option value="Manager">Manager</option>
               </select>
               <button type="button" onclick="removeStaffRow(${staffRowCount})" class="text-red-500 hover:text-red-700 p-1">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                   </svg>
               </button>
           `;
           
           staffContainer.appendChild(rowDiv);
       }

       // FIXED: Make this function global
       window.removeStaffRow = function(rowId) {
           const row = document.getElementById(`staffRow${rowId}`);
           if (row) {
               row.remove();
           }
       }

       // Create multiple assignments
       async function createMultipleAssignments(eventId, staffAssignments) {
           try {
               const assignments = staffAssignments.map(assignment => ({
                   booking_id: parseInt(eventId),
                   staff_id: parseInt(assignment.staffId),
                   role_assignment: assignment.role,
                   status: 'assigned'
               }));

               const { error } = await supabaseClient
                   .from('staff_assignment')
                   .insert(assignments);

               if (error) throw error;
               
               await loadData();
               document.getElementById('assignmentModal').classList.add('hidden');
               document.getElementById('assignmentForm').reset();
               document.getElementById('staffAssignments').innerHTML = '';
               staffRowCount = 0;
               showSuccess(`${assignments.length} staff members assigned successfully!`);
           } catch (error) {
               console.error('Error creating assignments:', error);
               showError('Error creating assignments');
           }
       }

       // Event listeners
       function setupEventListeners() {
           document.getElementById('createAssignmentBtn').addEventListener('click', () => {
               document.getElementById('assignmentModal').classList.remove('hidden');
               // Add initial staff row
               if (document.getElementById('staffAssignments').children.length === 0) {
                   addStaffRow();
               }
           });

           document.getElementById('createFirstBtn').addEventListener('click', () => {
               document.getElementById('assignmentModal').classList.remove('hidden');
               if (document.getElementById('staffAssignments').children.length === 0) {
                   addStaffRow();
               }
           });

           document.getElementById('addStaffBtn').addEventListener('click', addStaffRow);

           document.getElementById('closeModal').addEventListener('click', () => {
               document.getElementById('assignmentModal').classList.add('hidden');
               document.getElementById('staffAssignments').innerHTML = '';
               staffRowCount = 0;
           });

           document.getElementById('closeStaffModal').addEventListener('click', () => {
               document.getElementById('staffDetailsModal').classList.add('hidden');
           });

           document.getElementById('cancelBtn').addEventListener('click', () => {
               document.getElementById('assignmentModal').classList.add('hidden');
               document.getElementById('staffAssignments').innerHTML = '';
               staffRowCount = 0;
           });

           document.getElementById('assignmentForm').addEventListener('submit', (e) => {
               e.preventDefault();
               const eventId = document.getElementById('eventSelect').value;
               
               if (!eventId) {
                   showError('Please select an event');
                   return;
               }
               
               // Collect all staff assignments
               const staffRows = document.querySelectorAll('#staffAssignments > div');
               const staffAssignments = [];
               
               for (let row of staffRows) {
                   const staffSelect = row.querySelector('.staff-select');
                   const roleSelect = row.querySelector('.role-select');
                   
                   if (staffSelect.value && roleSelect.value) {
                       staffAssignments.push({
                           staffId: staffSelect.value,
                           role: roleSelect.value
                       });
                   }
               }
               
               if (staffAssignments.length === 0) {
                   showError('Please add at least one staff assignment');
                   return;
               }
               
               createMultipleAssignments(eventId, staffAssignments);
           });

           document.getElementById('logoutBtn').addEventListener('click', () => {
               if (confirm('Are you sure you want to logout?')) {
                   window.location.href = 'index.html';
               }
           });

           // Close modals when clicking outside
           document.getElementById('assignmentModal').addEventListener('click', (e) => {
               if (e.target.id === 'assignmentModal') {
                   document.getElementById('assignmentModal').classList.add('hidden');
                   document.getElementById('staffAssignments').innerHTML = '';
                   staffRowCount = 0;
               }
           });

           document.getElementById('staffDetailsModal').addEventListener('click', (e) => {
               if (e.target.id === 'staffDetailsModal') {
                   document.getElementById('staffDetailsModal').classList.add('hidden');
               }
           });
       }

       function showSuccess(message) {
           const notification = document.createElement('div');
           notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
           notification.textContent = message;
           document.body.appendChild(notification);
           setTimeout(() => notification.remove(), 3000);
       }

       function showError(message) {
           const notification = document.createElement('div');
           notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
           notification.textContent = message;
           document.body.appendChild(notification);
           setTimeout(() => notification.remove(), 5000);
       }
   </script>
</body>
</html>