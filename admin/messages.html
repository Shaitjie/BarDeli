<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Notifications - BarDeli Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bardeli-orange': '#ff6b35',
                        'bardeli-dark': '#e55a2b',
                        'bardeli-light': '#ff8f66'
                    }
                }
            }
        }
    </script>
    <style>
        .header-bg {
            background: linear-gradient(135deg, #ff6b35 0%, #e55a2b 100%);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="header-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <a href="admin-dashboard.html" class="text-white hover:text-bardeli-light">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                            </path>
                        </svg>
                    </a>
                    <h1 class="text-2xl font-bold text-white">Notifications</h1>
                </div>
                <button id="logoutBtn"
                    class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg text-sm">Logout</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Notifications</h2>
                <p class="text-gray-600">Communication with customers</p>
            </div>
            <button id="composeBtn"
                class="bg-bardeli-orange hover:bg-bardeli-dark text-white px-6 py-3 rounded-lg font-medium mt-4 lg:mt-0">
                + Send Notification
            </button>
        </div>

        <!-- Notification Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-sm font-medium text-gray-600 mb-1">Total Notifications</h3>
                <p class="text-2xl font-bold text-gray-900"><span id="message-total">0</span></p>
            </div>
        </div>

        <!-- Notifications List -->
        <div class="bg-white rounded-xl shadow-md border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">All Notifications</h3>
                    <div class="flex space-x-2">
                        <select class="text-sm border border-gray-300 rounded px-3 py-1">
                            <option>All Notifications</option>
                            <option>Unread</option>
                            <option>High Priority</option>
                            <option>Customer Notifications</option>
                            <option>Staff Notifications</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="all-notifications" class="p-6 overflow-x-auto">
                <table class="min-w-full bg-white rounded-xl shadow-md">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Customer Name</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Booking ID</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Title</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Message</th>
                        </tr>
                    </thead>
                    <tbody id="notification-table-body">
                        <!-- Notifications will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Compose Modal -->
    <div id="composeModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Send Notification</h3>
                    <button id="closeComposeModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">User</label>
                        <input id="customer-search" type="text" placeholder="Search customer..."
                            class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <ul id="customer-results"
                            class="absolute bg-white border rounded shadow-lg w-full mt-1 hidden z-50"></ul>
                        <input type="hidden" id="customer-id">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Booking</label>
                        <input id="booking-search" type="text" placeholder="Search booking..."
                            class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <ul id="booking-results"
                            class="absolute bg-white border rounded shadow-lg w-full mt-1 hidden z-50"></ul>
                        <input type="hidden" id="booking-id">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                        <input id="title" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Message subject">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Message</label>
                        <textarea id="message" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Type your message here..."></textarea>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Save Draft
                        </button>
                        <button type="submit"
                            class="bg-bardeli-orange hover:bg-bardeli-dark text-white px-6 py-2 rounded-lg">
                            Send Notification
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        const supabaseUrl = "https://fawlfsukrqrucrrxrjvq.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhd2xmc3VrcnFydWNycnhyanZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzU2OTUsImV4cCI6MjA3MTAxMTY5NX0.KGH5SAJvCEhnz3NHdp6LeMgCvZp-nP1Tj6oIL32J6K8";
        const supabase = createClient(supabaseUrl, supabaseKey);

        let selectedCustomerId = null;
        let selectedBookingId = null;

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '../index.html';
            }
        });

        // Modal controls
        document.getElementById('composeBtn').addEventListener('click', () => {
            document.getElementById('composeModal').classList.remove('hidden');
        });
        document.getElementById('closeComposeModal').addEventListener('click', () => {
            document.getElementById('composeModal').classList.add('hidden');
        });

        // Customer Search
        const customerInput = document.getElementById("customer-search");
        const customerResults = document.getElementById("customer-results");

        customerInput.addEventListener("input", async (e) => {
            const query = e.target.value.trim();
            if (!query) return customerResults.classList.add("hidden");

            const { data, error } = await supabase
                .from("users")
                .select("user_id, first_name, last_name, email")
                .or(`first_name.ilike.%${query}%,email.ilike.%${query}%`)
                .limit(5);

            if (error) return console.error(error);

            customerResults.innerHTML = "";
            if (data.length) {
                data.forEach(cust => {
                    const li = document.createElement("li");
                    li.textContent = `${cust.first_name} ${cust.last_name} (${cust.email})`;
                    li.className = "px-3 py-2 hover:bg-gray-100 cursor-pointer";
                    li.addEventListener("click", () => {
                        customerInput.value = `${cust.first_name} ${cust.last_name} (${cust.email})`;
                        selectedCustomerId = cust.user_id;
                        customerResults.innerHTML = "";
                        customerResults.classList.add("hidden");
                    });
                    customerResults.appendChild(li);
                });
                customerResults.classList.remove("hidden");
            } else customerResults.classList.add("hidden");
        });

        // Booking Search
        const bookingInput = document.getElementById("booking-search");
        const bookingResults = document.getElementById("booking-results");

        bookingInput.addEventListener("input", async (e) => {
            const query = e.target.value.trim();
            if (!query) return bookingResults.classList.add("hidden");

            let filter = /^\d+$/.test(query)
                ? `booking_id.eq.${query}`
                : `event_type.ilike.%${query}%,event_date.ilike.%${query}%`;

            const { data, error } = await supabase
                .from("booking")
                .select("booking_id, event_date, event_type")
                .or(filter)
                .limit(5);

            if (error) return console.error(error);

            bookingResults.innerHTML = "";
            if (data.length) {
                data.forEach(book => {
                    const li = document.createElement("li");
                    li.textContent = `#${book.booking_id} - ${book.event_date} (${book.event_type})`;
                    li.className = "px-3 py-2 hover:bg-gray-100 cursor-pointer";
                    li.addEventListener("click", () => {
                        bookingInput.value = `#${book.booking_id} - ${book.event_date} (${book.event_type})`;
                        selectedBookingId = book.booking_id;
                        bookingResults.innerHTML = "";
                        bookingResults.classList.add("hidden");
                    });
                    bookingResults.appendChild(li);
                });
                bookingResults.classList.remove("hidden");
            } else bookingResults.classList.add("hidden");
        });

        // Load Notifications 
        async function loadNotifications() {
            const { data, error } = await supabase
                .from("notification")
                .select(`
                    notification_id,
                    title,
                    message,
                    users:user_id (first_name, last_name),
                    booking:booking_id (booking_id, event_date, event_type)
                `)
                .order("notification_id", { ascending: false });

            if (error) {
                console.error("Error loading notifications:", error);
                return;
            }

            const tbody = document.getElementById("notification-table-body");
            tbody.innerHTML = ""; // clear table

            if (!data.length) {
                tbody.innerHTML = `<tr>
                    <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                    No notifications yet
                    </td>
                </tr>`;
                return;
            }

            data.forEach(n => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900">
                        ${n.users ? `${n.users.first_name} ${n.users.last_name}` : "Unknown"}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        ${n.booking ? n.booking.booking_id : "-"}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        ${n.title}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-700">
                        ${n.message}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        //Loads notifications stats (How many notifications sent) @ Total Notifications
        async function loadMessageStats() {
            const { count, error } = await supabase
                .from("notification")
                .select("*", { count: "exact", head: true });
            if (error) return console.error(error);
            document.getElementById("message-total").textContent = count ?? 0;
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadNotifications();
            loadMessageStats();
        });

        // Send Notification
        const form = document.querySelector("#composeModal form");
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("title").value.trim();
            const message = document.getElementById("message").value.trim();

            if (!selectedCustomerId || !selectedBookingId || !title || !message) {
                return alert("Please complete all fields before sending.");
            }

            const { error } = await supabase.from("notification").insert([{
                user_id: selectedCustomerId,
                booking_id: selectedBookingId,
                title,
                message
            }]);

            if (error) {
                console.error(error);
                alert("Failed to send notification.");
            } else {
                alert("Notification sent successfully!");
                form.reset();
                selectedCustomerId = null;
                selectedBookingId = null;
                document.getElementById('composeModal').classList.add('hidden');
                loadNotifications();
                loadMessageStats();
            }
        });
    </script>
</body>

</html>
