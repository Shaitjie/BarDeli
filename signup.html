<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Sign Up</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<!-- <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
		integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body
	class="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-orange-50 via-white to-orange-100">
	<div class="w-full max-w-md bg-white shadow-2xl rounded-2xl p-8">
		<!-- Logo -->
		<div class="flex justify-center mb-4">
			<img onclick="window.location.href='index.html'" src="images/BarDeli Logo (Black).png" alt="Logo" class="h-24 w-24">
		</div>

		<h1 class="text-3xl font-extrabold text-center mb-6 text-gray-900">Create your Account</h1>

		<!-- Signup Form -->
		<form id="signup-form" class="space-y-5">
			<!-- Full Name -->
			<div>
				<label class="block text-sm font-medium text-gray-700">Full Name</label>
				<input id="fullname" type="text" required
					class="mt-1 w-full rounded-xl border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-[#FB8C00] focus:border-[#FB8C00] transition" />
			</div>

			<!-- Email -->
			<div>
				<label class="block text-sm font-medium text-gray-700">Email</label>
				<input id="email" type="email" required
					class="mt-1 w-full rounded-xl border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-[#FB8C00] focus:border-[#FB8C00] transition" />
			</div>

			<!-- Phone -->
			<div>
				<label class="block text-sm font-medium text-gray-700">Phone</label>
				<input id="phone" type="tel" pattern="0[0-9]{9}" maxlength="10" required placeholder="0XXXXXXXXX" class="mt-1 w-full rounded-xl border border-gray-300 px-4 py-2 
			           focus:ring-2 focus:ring-[#FB8C00] focus:border-[#FB8C00] transition" />
				<p class="text-xs text-gray-500">Phone number must be 10 digits and start with 0.</p>
			</div>

			<!-- Role -->
			<div>
				<label class="block text-sm font-medium">Role</label>
				<select id="role" class="mt-1 w-full rounded-xl border px-3 py-2">
					<option value="Customer" selected>Customer</option>
					<!-- <option value="Admin">Admin</option> -->
				</select>
			</div>

			<!-- Password -->
			<div>
				<label class="block text-sm font-medium text-gray-700">Password</label>
				<input id="password" type="password" required
					class="mt-1 w-full rounded-xl border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-[#FB8C00] focus:border-[#FB8C00] transition" />
			</div>

			<!-- Confirm Password -->
			<div>
				<label class="block text-sm font-medium text-gray-700">Confirm Password</label>
				<input id="confirm_password" type="password" required
					class="mt-1 w-full rounded-xl border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-[#FB8C00] focus:border-[#FB8C00] transition" />
			</div>

			<!-- Show Password -->
			<label class="inline-flex items-center space-x-2">
				<input id="show_pw" type="checkbox"
					class="rounded border-gray-300 text-[#FB8C00] focus:ring-[#FB8C00]" />
				<span class="text-sm text-gray-700">Show password</span>
			</label>

			<!-- Submit Button -->
			<button id="signup" type="submit"
				class="w-full rounded-xl bg-[#FB8C00] hover:bg-[#e07c00] text-white py-3 font-semibold shadow-md transition">
				<i class="fa-solid fa-user-plus"></i> Sign Up
			</button>

			<!-- Link to Login -->
			<p class="text-sm text-center text-gray-600">
				Already have an account?
				<a href="login.html" class="text-[#FB8C00] font-semibold hover:underline">Log in</a>
			</p>

			<!-- Message -->
			<p id="msg" class="text-sm text-center text-gray-600"></p>
		</form>
	</div>

	<script type="module">
		import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

		const supabaseUrl = 'https://fawlfsukrqrucrrxrjvq.supabase.co'
		const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhd2xmc3VrcnFydWNycnhyanZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzU2OTUsImV4cCI6MjA3MTAxMTY5NX0.KGH5SAJvCEhnz3NHdp6LeMgCvZp-nP1Tj6oIL32J6K8'
		const supabase = createClient(supabaseUrl, supabaseKey)

		// Show password toggle
		document.getElementById('show_pw').addEventListener('change', (e) => {
			const type = e.target.checked ? 'text' : 'password';
			document.getElementById('password').type = type;
			document.getElementById('confirm_password').type = type;
		});

		// 🧹 Sanitize Input Function
		function sanitizeInput(input) {
			return input
				.replace(/[<>]/g, "")  // remove angle brackets
				.replace(/['";]/g, "") // remove common SQL special chars
				.trim();               // remove extra spaces
		}

		// Phone Validation
		const phoneInput = document.getElementById("phone");
		let isRefocusingPhone = false; // 👈 Prevents the loop

		// Keep input clean while typing
		phoneInput.addEventListener("input", () => {
			// Remove non-digits
			phoneInput.value = phoneInput.value.replace(/\D/g, '');

			// Ensure it always starts with 0
			if (phoneInput.value && !phoneInput.value.startsWith("0")) {
				phoneInput.value = "0" + phoneInput.value.replace(/^0+/, "");
			}

			// Limit length to 10
			if (phoneInput.value.length > 10) {
				phoneInput.value = phoneInput.value.slice(0, 10);
			}
		});

		// Validate only when leaving the field
		phoneInput.addEventListener("blur", () => {
			// 🚫 Skip validation if we just re-focused programmatically
			if (isRefocusingPhone) return;

			if (phoneInput.value.length !== 10) {
				alert("Please enter a valid 10-digit phone number starting with 0.");
				phoneInput.value = "";

				// 🔒 Prevent loop
				isRefocusingPhone = true;
				phoneInput.focus();

				// 🕑 Allow blur again after short delay
				setTimeout(() => {
					isRefocusingPhone = false;
				}, 200);
			}
		});

		document.addEventListener('DOMContentLoaded', () => {

			const signupButton = document.getElementById('signup')
			const fullname = document.getElementById('fullname')
			const phone = document.getElementById('phone')
			const role = document.getElementById('role')
			const email = document.getElementById('email')
			const password = document.getElementById('password')

			signupButton.addEventListener('click', async (e) => {
				e.preventDefault()

				if (!fullname.value || !phone.value || !email.value || !password.value) {
					alert('Please fill in all fields')
					return
				}

				signupButton.disabled = true
				signupButton.textContent = 'Signing up...'

				try {
					// Sanitize all inputs before sending to Supabase
					const cleanFullname = sanitizeInput(fullname.value)
					const cleanEmail = sanitizeInput(email.value)

					// 1️⃣ Create user in Supabase Auth
					const { data: authData, error: authError } = await supabase.auth.signUp({
						email: email.value,
						password: password.value
					})

					if (authError) throw authError

					const { data, error } = await supabase
						.from('users')
						.insert([{
							auth_user_id: authData.user.id,
							first_name: cleanFullname.split(" ")[0] || "",
							last_name: cleanFullname.split(" ").slice(1).join(" ") || "",
							email: cleanEmail.value,
							phone: phone.value,
							role: role.value
						}])

					if (error) throw error

					alert('Signup successful! Redirecting to login...')
					window.location.href = "login.html"

				} catch (err) {
					console.error('Signup error:', err)
					alert('Signup failed: ' + err.message)
				} finally {
					signupButton.disabled = false
					signupButton.textContent = 'Sign Up'
				}
			})
		});

		

		// ===== FULL NAME VALIDATION =====
		const fullnameInput = document.getElementById("fullname");

		fullnameInput.addEventListener("input", () => {
			const namePattern = /^[A-Za-z\s]+$/;

			// Allow empty input (user still typing or deleting)
			if (fullnameInput.value === "") return;

			// Check if the input has invalid characters
			if (!namePattern.test(fullnameInput.value)) {
				alert("Full name can only contain letters and spaces.");
				// Remove invalid character immediately
				fullnameInput.value = fullnameInput.value.replace(/[^A-Za-z\s]/g, "");
			}
		});

		// ===== EMAIL VALIDATION =====
		const emailInput = document.getElementById("email");
		let isRefocusing = false; // 👈 flag to prevent the loop

		emailInput.addEventListener("blur", () => {
			// Prevent triggering again when refocusing
			if (isRefocusing) return;

			const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-z]{2,}$/;
			document.getElementById("emailError")?.remove();

			if (!emailPattern.test(emailInput.value)) {
				// Create error message
				const emailError = document.createElement("p");
				emailError.id = "emailError";
				emailError.className = "text-sm text-red-500 mt-1";
				emailError.textContent = "Please enter a valid email address (e.g., john@email.com).";
				emailInput.insertAdjacentElement("afterend", emailError);

				alert("Invalid email format. Please re-enter your email.");
				emailInput.value = "";

				// 🔒 Prevent loop: mark as refocusing before focusing back
				isRefocusing = true;
				emailInput.focus();

				// 🕑 Small delay to reset flag after focus stabilizes
				setTimeout(() => {
					isRefocusing = false;
				}, 200);
			}
		});

	</script>

</body>

</html>
